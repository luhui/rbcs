# 一、账户管理用例

### 1. 创建账户（CREATE_ACCOUNT）

- **用例名称**：创建账户
- **参与者**：业务系统（IS）
- **前置条件**：无
- **主流程**：
    1. 业务系统发起创建账户请求。
    2. 输入账户相关信息，包括账户号、初始余额、账户类型等。
    3. 系统验证输入信息的合法性，如账户号的唯一性、初始余额的格式等。
    4. 使用数据库事务或锁机制确保并发情况下账户号的唯一性：
        - 在数据库层面，可以使用唯一索引约束账户号字段，防止并发创建相同账户号的账户。
        - 或者在创建账户时，使用数据库事务，先尝试插入账户记录，若出现重复账户号冲突则回滚事务。
    5. 系统创建新的账户记录并存储在数据库中。
    6. 系统返回创建成功信息，包括新创建的账户的基本信息。
- **异常处理**：
    - 若输入信息不合法，系统返回相应的错误信息，提示用户修改。
    - 若因数据库或其他系统故障导致账户创建失败，系统返回创建失败信息及可能的原因。
    - 在并发情况下，如果因账户号冲突导致创建失败，系统返回账户号已存在的提示信息。

### 2. 查询账户（QUERY_ACCOUNT）

- **用例名称**：查询账户
- **参与者**：业务系统（IS）
- **前置条件**：账户已创建
- **主流程**：
    1. 业务系统发起查询账户请求，可通过账户号或其他唯一标识进行查询。
    2. 系统根据请求信息查找相应账户记录。
    3. 系统返回账户的详细信息，包括账户号、余额、状态、账户类型等。
- **异常处理**：
    - 若查询不到账户，系统返回相应的提示信息。
    - 若因系统故障导致查询失败，系统返回查询失败信息及可能的原因。
    - 在并发情况下，为避免大量查询请求对数据库造成压力，可以使用缓存机制，先查询缓存，如果缓存未命中再查询数据库，更新缓存。

### 3. 冻结账户（FREEZE_ACCOUNT）

- **用例名称**：冻结账户
- **参与者**：管理员（AS）
- **前置条件**：账户已创建且处于激活状态
- **主流程**：
    1. 管理员发起冻结账户请求，指定要冻结的账户。
    2. 系统检查管理员权限。
    3. 系统更新账户状态为“冻结”，取消所有正在进行的相关交易，并存储更新后的账户信息。
    4. 系统返回冻结成功信息。
- **异常处理**：
    - 若管理员权限不足，系统拒绝操作并返回权限不足信息。
    - 若账户不存在或已处于冻结状态，系统返回相应的提示信息。
    - 若因系统故障导致冻结操作失败，系统返回冻结失败信息及可能的原因。
    - 在并发情况下，如果获取锁失败，系统可以等待一段时间后重试或返回并发操作冲突的提示信息。

### 4. 激活账户（ACTIVE_ACCOUNT）

- **用例名称**：激活账户
- **参与者**：业务系统（IS）
- **前置条件**：账户已创建且处于冻结状态
- **主流程**：
    1. 业务系统发起激活账户请求，指定要激活的账户。
    2. 系统验证账户的存在性和当前状态。
    3. 系统更新账户状态为“激活”，并存储更新后的账户信息。
    4. 系统返回激活成功信息。
- **异常处理**：
    - 若账户不存在或已处于激活状态，系统返回相应的提示信息。
    - 若因系统故障导致激活操作失败，系统返回激活失败信息及可能的原因。
    - 在并发情况下，如果获取锁失败，系统可以等待一段时间后重试或返回并发操作冲突的提示信息。

### 二、交易处理用例

### 1. 发起交易（CREATE_TRANSACTION）

- **用例名称**：发起交易
- **参与者**：业务系统（IS）
- **前置条件**：源账户和目标账户已创建且处于激活状态
- **主流程**：
    1. 业务系统发起交易请求，包括选择交易类型（存款、取款、转账），输入交易金额、源账户和目标账户等信息。
    2. 系统验证交易信息的合法性，如源账户和目标账户的存在性和状态，交易金额的合理性等。
    3. 根据交易类型调用相应的子流程（存款、取款、转账），使用数据库事务确保交易的原子性：
        - 在进行存款、取款或转账操作时，将多个操作（如更新源账户余额、更新目标账户余额、记录交易信息）放在一个事务中，保证要么全部成功，要么全部失败。
    4. 系统更新账户余额和交易记录，并存储在数据库中。
    5. 系统返回交易成功信息，包括交易的详细信息。
- **异常处理**：
    - 若交易信息不合法，系统返回相应的错误信息，提示用户修改。
    - 若源账户或目标账户状态异常，系统返回相应的提示信息。
    - 若因系统故障导致交易失败，系统返回交易失败信息及可能的原因。
    - 在并发情况下，如果出现并发更新余额导致的余额不足问题，系统可以返回余额不足信息，或者使用乐观锁机制进行处理（如添加版本号字段，更新时检查版本号是否匹配）。

### 2. 查询交易（QUERY_TRANSACTION）

- **用例名称**：查询交易
- **参与者**：业务系统（IS）
- **前置条件**：交易已发起
- **主流程**：
    1. 业务系统发起查询交易请求，可通过交易ID或其他筛选条件进行查询。
    2. 系统根据请求信息查找相应交易记录。
    3. 系统返回交易的详细信息，包括交易ID、源账户、目标账户、交易金额、时间戳、状态等。
- **异常处理**：
    - 若查询不到交易，系统返回相应的提示信息。
    - 若因系统故障导致查询失败，系统返回查询失败信息及可能的原因。
    - 在并发情况下，为避免大量查询请求对数据库造成压力，可以使用缓存机制，先查询缓存，如果缓存未命中再查询数据库，更新缓存。

### 3. 存款（C1）

- **用例名称**：存款
- **参与者**：业务系统（IS）
- **前置条件**：账户已创建且处于激活状态
- **主流程**：
    1. 业务系统发起存款请求，指定存款账户和存款金额。
    2. 系统验证账户的存在性和状态。
    3. 使用锁机制（如数据库行级锁或分布式锁）确保在更新账户余额时不会被其他并发操作干扰。
    4. 系统更新账户的余额，增加相应的存款金额。
    5. 系统记录存款交易信息，包括存款账户、存款金额、时间戳等。
    6. 系统返回存款成功信息，包括更新后的账户余额和交易信息。
- **异常处理**：
    - 若账户不存在或状态异常，系统返回相应的提示信息。
    - 若因系统故障导致存款操作失败，系统返回存款失败信息及可能的原因。
    - 在并发情况下，如果获取锁失败，系统可以等待一段时间后重试或返回并发操作冲突的提示信息。

### 4. 取款（C2）

- **用例名称**：取款
- **参与者**：业务系统（IS）
- **前置条件**：账户已创建且处于激活状态，账户余额足够
- **主流程**：
    1. 业务系统发起取款请求，指定取款账户和取款金额。
    2. 系统验证账户的存在性、状态和账户余额是否足够。
    3. 使用锁机制（如数据库行级锁或分布式锁）确保在更新账户余额时不会被其他并发操作干扰。
    4. 系统更新账户的余额，减去相应的取款金额。
    5. 系统记录取款交易信息，包括取款账户、取款金额、时间戳等。
    6. 系统返回取款成功信息，包括更新后的账户余额和交易信息。
- **异常处理**：
    - 若账户不存在或状态异常，系统返回相应的提示信息。
    - 若账户余额不足，系统返回余额不足的提示信息。
    - 若因系统故障导致取款操作失败，系统返回取款失败信息及可能的原因。
    - 在并发情况下，如果获取锁失败，系统可以等待一段时间后重试或返回并发操作冲突的提示信息。

### 5. 转账（C3）

- **用例名称**：转账
- **参与者**：业务系统（IS）
- **前置条件**：源账户和目标账户已创建且处于激活状态，源账户余额足够
- **主流程**：
    1. 业务系统发起转账请求，指定源账户、目标账户和转账金额。
    2. 系统验证账户的存在性、状态和源账户余额是否足够。
    3. 使用锁机制（如数据库行级锁或分布式锁）确保在更新账户余额时不会被其他并发操作干扰。
    4. 系统更新源账户的余额，减去相应的转账金额。
    5. 系统更新目标账户的余额，增加相应的转账金额。
    6. 系统记录转账交易信息，包括源账户、目标账户、转账金额、时间戳等。
    7. 系统返回转账成功信息，包括更新后的源账户和目标账户余额以及交易信息。
- **异常处理**：
    - 若账户不存在或状态异常，系统返回相应的提示信息。
    - 若源账户余额不足，系统返回余额不足的提示信息。
    - 若因系统故障导致转账操作失败，系统返回转账失败信息及可能的原因。
    - 在并发情况下，如果获取锁失败，系统可以等待一段时间后重试或返回并发操作冲突的提示信息。

在并发场景下，使用锁机制、数据库事务和缓存等技术可以有效地避免数据不一致、资源竞争等问题，确保系统在高并发情况下的稳定性和可靠性。以下是一些关键技术的解释：

- **数据库事务**：确保一组操作要么全部成功，要么全部失败，保证数据的一致性，适用于涉及多个数据库操作的场景，如转账时同时更新源账户和目标账户余额及记录交易信息。
- **数据库行级锁**：在更新数据库记录时，对相应行加锁，防止其他并发操作对该行数据进行修改，确保数据的一致性。
- **分布式锁**：在分布式系统中，当多个服务或节点可能同时操作同一资源时，使用分布式锁确保同一时刻只有一个操作可以修改资源，避免并发冲突。
- **缓存机制**：将频繁查询的数据存储在缓存中，减少对数据库的直接访问，提高系统性能，同时避免大量并发查询对数据库造成压力。

这些功能用例的设计考虑了并发场景下的各种情况，为开发和维护高并发的实时余额计算系统提供了详细的指导和参考。在实际开发中，可以根据具体的技术栈和架构进一步细化和优化这些用例。